<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æ¯é€±é‹å‹•è¨ˆç•« Â· Personal Weekly Fitness</title>
  <style>
    /* ===== CSS:BASE ====414= */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC";
      background: #ffffff;
      color: #101820;
      line-height: 1.5;
    }
    .page { min-height: 100vh; display: flex; flex-direction: column; }
    .container { width: 100%; max-width: 960px; margin: 0 auto; padding: 0 16px; }

    /* ===== Header ===== */
    header.site-header {
      background: #f8fafb;
      border-bottom: 1px solid #e6eef6;
      position: sticky;
      top: 0; z-index: 999;
    }
    .nav { display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .site-title { font-size: 1.1rem; font-weight: 700; color: #0b556a; text-decoration: none; }
    .nav-links { display: flex; gap: 12px; }
    .nav-link { color: #0b556a; text-decoration: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;}
    .nav-link:hover { background: rgba(11,85,106,0.08); }

    /* ===== Sections ===== */
    .section { padding: 30px 0; }
    .section-title { font-size: 1.2rem; color: #0b556a; margin: 0 0 12px 0; }

    /* ===== Cards / Inputs ===== */
    .card {
      background: #ffffff;
      border: 1px solid #eaeef2;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .input-pill {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #dbe4e8;
      font-size: 1rem;
    }
    .input-group { margin-bottom: 12px; }
    select.input-pill { background: white; }

    button.btn {
      background: #0b556a;
      color: white;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 6px;
      transition: background 0.2s;
    }
    button.btn:hover { background: #084152; }
    button.btn:active { transform: translateY(1px); }

    /* ===== Plan Cards ===== */
    .plan-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .plan-day {
      border-left: 5px solid #0b556a;
      padding-left: 16px;
    }
    .day-header { display: flex; justify-content: space-between; align-items: baseline; }
    .day-title { margin: 0; font-size: 1.1rem; }
    .day-date { font-size: 0.85rem; color: #889; }
    .plan-suggestion { font-weight: 600; color: #2c3e50; margin: 8px 0; font-size: 1.05rem; }
    .plan-logic { color: #889; font-size: 0.85rem; margin: 0; }

    /* ===== LOG SECTION ===== */
    .log-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .log-item { flex: 1; min-width: 180px; }

    @media (min-width: 768px) {
      .plan-grid { grid-template-columns: repeat(2,1fr); }
    }
    @media (min-width: 1200px) {
      .plan-grid { grid-template-columns: repeat(3,1fr); }
    }
  </style>
</head>

<body>
  <div class="page">

    <header class="site-header">
      <div class="container nav">
        <a class="site-title" href="#hero">MyWeekly Â· é‹å‹•è¨ˆç•«</a>
        <nav class="nav-links">
          <a href="#hero" class="nav-link">é¦–é </a>
          <a href="#weekplan-section" class="nav-link">æœ¬é€±è¨ˆç•«</a>
          <a href="#log-section" class="nav-link">ç´€éŒ„</a>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">

        <section id="hero" class="section section-hero">
          <h1 class="section-title">è¼¸å…¥æœ¬é€±è¡Œç¨‹</h1>

          <div class="card">
            <p>è«‹é¸æ“‡æœ¬é€±åœ¨å®¶å·¥ä½œæ—¥ï¼ˆå¤šé¸ï¼‰ï¼š</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 16px;">
              <label><input type="checkbox" class="wfh-day" value="1"> ä¸€</label>
              <label><input type="checkbox" class="wfh-day" value="2"> äºŒ</label>
              <label><input type="checkbox" class="wfh-day" value="3"> ä¸‰</label>
              <label><input type="checkbox" class="wfh-day" value="4"> å››</label>
              <label><input type="checkbox" class="wfh-day" value="5"> äº”</label>
            </div>

            <p style="margin-top:16px; border-top: 1px solid #eee; padding-top:16px;"></p>
              <div class="input-group">
                <label for="sat-activity">é€±å…­æ´»å‹•</label>
                <select id="sat-activity" class="input-pill">
                  <option value="none">ç„¡æ´»å‹•ï¼ˆå¯é‹å‹•ï¼‰</option>
                  <option value="half">åŠå¤©æœ‰æ´»å‹•ï¼ˆè¼•åº¦é‹å‹•ï¼‰</option>
                  <option value="full">æ•´å¤©æœ‰æ´»å‹•ï¼ˆä»¥ä¼¸å±•ç‚ºä¸»ï¼‰</option>
                </select>
              </div>

              <div class="input-group">
                <label for="sun-activity">é€±æ—¥æ´»å‹•</label>
                <select id="sun-activity" class="input-pill">
                  <option value="none">ç„¡æ´»å‹•ï¼ˆå¯é‹å‹•ï¼‰</option>
                  <option value="half">åŠå¤©æœ‰æ´»å‹•ï¼ˆè¼•åº¦é‹å‹•ï¼‰</option>
                  <option value="full">æ•´å¤©æœ‰æ´»å‹•ï¼ˆä»¥ä¼¸å±•ç‚ºä¸»ï¼‰</option>
                </select>
              </div>

            <div style="margin-top:24px;">
              <button id="initial-generate-btn" class="btn">ç”¢ç”Ÿæœ¬é€±å»ºè­°</button>
              <button id="regenerate-btn" class="btn" style="background:#6c757d;">é‡æ–°ç”Ÿæˆ</button>
            </div>
          </div>
        </section>

        <section id="weekplan-section" class="section section-week-plan">
          <h2 class="section-title">æœ¬é€±é‹å‹•è¨ˆç•«</h2>
          <div id="weekly-plan-container" class="plan-grid">
            <div style="color:#888; grid-column: 1/-1;">å°šæœªç”Ÿæˆè¨ˆç•«ï¼Œè«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•ã€‚</div>
          </div>
        </section>

        <section id="log-section" class="section section-log">
          <h2 class="section-title">æ¯æ—¥é‹å‹•ç´€éŒ„</h2>

          <div class="card">
            <div class="log-row">
              <div class="log-item">
                <label>æ—¥æœŸï¼š</label>
                <input id="log-date" class="input-pill" type="date" />
              </div>

              <div class="log-item">
                <label>å¯¦éš›é‹å‹•å…§å®¹ï¼š</label>
                <input id="actual-activity" class="input-pill" type="text" placeholder="ä¾‹å¦‚ï¼šè·‘æ­¥ 20 åˆ†" />
              </div>
                
              <div class="log-item">
                <label>æ™‚é–“ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
                <input id="log-duration" class="input-pill" type="number" min="1" />
              </div>
            </div>

            <div style="margin-top:12px;">
              <label>å‚™è¨»ï¼š</label>
              <input id="log-note" class="input-pill" type="text" placeholder="å¯ç•™ç©º" />
            </div>

            <div style="margin-top:18px;">
              <button id="log-save-btn" class="btn">å›å­˜ç´€éŒ„</button>
            </div>

            <p id="log-message" style="color:#0b556a; margin-top:10px;"></p>
          </div>
        </section>

      </div>
    </main>

    <footer class="site-footer" style="padding:16px; text-align:center; background:#f5f8fa; color: #888;">
      MyWeekly Â· é‹å‹•è¨ˆç•«
    </footer>
  </div>

<script>
    /* =====================
       1. è³‡æ–™è¨­å®šèˆ‡ API
    ====================== */
    // â˜… è«‹å°‡ä¸‹æ–¹ç¶²å€æ›æˆæ‚¨æœ€æ–°éƒ¨ç½²å¾Œå–å¾—çš„æ–°ç¶²å€ â˜…
    const API_BASE = "https://script.google.com/macros/s/AKfycbySvjyvZZsGZuhv0W-dnbuJH0mMg8CXK9MAToktPCY5oMRNooA-q0AZ_VoRcMJXhbmc/exec"; 
    
    let MOCK_HISTORY = ["è·‘æ­¥ (30åˆ†)", "é‡é‡è¨“ç·´#1 (20åˆ†)"]; 
    
    // â˜… æ–°å¢å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜ç•¶é€±è¨ˆç•« â˜…
    let currentPlan = []; 

    async function callAPI(action, method="GET", body=null) {
      const options = { method };
      
      if (method === "POST" && body) {
         options.body = JSON.stringify(body);
      }
      
      try {
        const res = await fetch(`${API_BASE}?action=${action}`, options);
        if (!res.ok) {
            throw new Error(`API éŒ¯èª¤ï¼š${res.status} ${res.statusText}`);
        }
        return await res.json();
      } catch (e) {
        console.error("API Error:", e);
        if(action !== 'getWeeklyPlan' && action !== 'getExerciseList') {
            alert(`API å‘¼å«å¤±æ•— (${action})ï¼Œè«‹æª¢æŸ¥ Consoleã€‚`);
        }
        return null;
      }
    }

    async function fetchExerciseList(){ 
      const data = await callAPI("getExerciseList");
      return data || { "Yoga":[], "Cardio":[], "Weight":[], "Running":[], "Stretching":[] };
    }
    
    async function fetchWeeklyPlan(){ return await callAPI("getWeeklyPlan"); }
    async function fetchExerciseLog(){ return await callAPI("getExerciseLog"); }

    async function saveWeeklyPlan(plan){ return callAPI("saveWeeklyPlan","POST",{plan}); }
    async function saveExerciseLog(log){ return callAPI("saveLog","POST",log); } // ç¢ºä¿å¾Œç«¯ action æ˜¯ saveLog

    // æ–°å¢ï¼šé é¢è¼‰å…¥æ™‚è‡ªå‹•è®€å–
    async function loadCurrentPlan() {
        const initialGenerateBtn = document.getElementById("initial-generate-btn");
        const regenerateBtn = document.getElementById("regenerate-btn");

        initialGenerateBtn.innerText = "è®€å–ä¸­...";
        initialGenerateBtn.disabled = true;

        const [planData, logData] = await Promise.all([
            fetchWeeklyPlan(),
            fetchExerciseLog()
        ]);
        
        if (planData && planData.length > 0) {
            // â˜… è¼‰å…¥æˆåŠŸå¾Œï¼Œå„²å­˜è‡³å…¨åŸŸè®Šæ•¸ â˜…
            currentPlan = planData; 
            
            const logMap = logToMap(logData);
            renderWeeklyPlan(planData, logMap);
            
            initialGenerateBtn.style.display = 'none';
            regenerateBtn.style.display = 'inline-block';
            regenerateBtn.innerText = "é‡æ–°ç”Ÿæˆ";
            regenerateBtn.disabled = false;
            document.getElementById("weekplan-section").scrollIntoView({ behavior: 'smooth' });
        } else {
            currentPlan = []; // æ¸…ç©ºè¨ˆç•«
            initialGenerateBtn.innerText = "ç”¢ç”Ÿæœ¬é€±å»ºè­°";
            initialGenerateBtn.disabled = false;
            initialGenerateBtn.style.display = 'inline-block';
            regenerateBtn.style.display = 'none';
            document.getElementById("weekly-plan-container").innerHTML = '<div style="color:#888; grid-column: 1/-1;">å°šæœªç”Ÿæˆè¨ˆç•«ï¼Œè«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•ã€‚</div>';
        }
    }


    /* =====================
       2. æ ¸å¿ƒé‚è¼¯ï¼šç”Ÿæˆé‹å‹•è¨ˆç•« (æ­¤è™•é‚è¼¯ä¿æŒä¸è®Š)
    ====================== */
    function generateWeeklyPlan(user, db, history) {
      // ... (æ­¤è™•é‚è¼¯ä¿æŒä¸è®Š) ...
      const { wfhDays, satActivity, sunActivity } = user;
      const plan = [];
      const weekdays = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"];
      let selectedThisWeek = new Set();
      for(let i=0; i<7; i++){
          let suggestion = [];
          const dayIdx = i + 1; 
          // ... (æ­¤è™•é‚è¼¯ä¿æŒä¸è®Š) ...
          plan.push({
            weekday: weekdays[i],
            suggestion: suggestion.join(" + "),
            logic_note: logicNote,
            date: getDateOfWeek(i)
          });
      }
      return plan;
    }

    function pickExercise(list, history, currentWeekSet) {
      // ... (æ­¤è™•é‚è¼¯ä¿æŒä¸è®Š) ...
      if(!list || list.length === 0) return "è‡ªç”±ä¼¸å±•";
      let candidates = list.filter(ex => {
         const isPlayed = history.some(h => ex.includes(h)) || currentWeekSet.has(ex);
         return !isPlayed;
      });

      if(candidates.length === 0) candidates = list;
      const picked = getRandomItem(candidates);
      currentWeekSet.add(picked);
      return picked;
    }

    function getRandomItem(arr) {
      if(!arr || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getDateOfWeek(index){
      const today = new Date();
      const day = today.getDay() || 7; 
      if(day !== 1) today.setHours(-24 * (day - 1)); 
      const d = new Date(today);
      d.setDate(today.getDate() + index);
      return d.toISOString().split("T")[0];
    }
    // ... (ä»¥ä¸Šå‡½å¼ä¿æŒä¸è®Š) ...


    /* =====================
       3. è³‡æ–™è™•ç†èˆ‡ç•«é¢æ¸²æŸ“ (ä¿æŒä¸è®Š)
    ====================== */
    function logToMap(logs) {
        const logMap = new Map();
        if (logs && logs.length > 0) {
            logs.forEach(log => {
                const dateStr = log.date instanceof Date ? log.date.toISOString().split('T')[0] : log.date;
                logMap.set(dateStr, {
                    actual: log.actual || log.Actual || '', 
                    duration: log.duration || log.Duration || 0,
                    note: log.note || log.Note || '',
                });
            });
        }
        return logMap;
    }

    function renderWeeklyPlan(plan, logMap = new Map()){
      const container = document.getElementById("weekly-plan-container");
      container.innerHTML = "";
      
      plan.forEach(p => {
        const card = document.createElement("div");
        card.className = "card plan-day";
        
        const actualLog = logMap.get(p.date);

        let color = "#0b556a"; 
        let actualDisplay = "å¾…ç´€éŒ„";
        let logNote = "";
        
        if (actualLog && actualLog.actual) { 
            const durationText = actualLog.duration > 0 ? `${actualLog.duration} åˆ†é˜` : '0 åˆ†é˜';
            actualDisplay = `${actualLog.actual} (${durationText})`;
            logNote = actualLog.note ? `å‚™è¨»ï¼š${actualLog.note}` : '';
            color = actualLog.duration > 0 ? "#27ae60" : "#95a5a6"; 
        } else {
            if(p.suggestion.includes("ä¼¸å±•") || p.suggestion.includes("ä¼‘æ¯")) color = "#2ecc71";
            if(p.suggestion.includes("+")) color = "#e74c3c";
        }

        card.style.borderLeftColor = color;
        card.innerHTML = `
          <div class="day-header">
            <h3 class="day-title">é€±${p.weekday}</h3>
            <span class="day-date">${p.date}</span>
          </div>
          <p class="plan-suggestion">å»ºè­°ï¼š${p.suggestion}</p>
          <p class="plan-actual" style="color:${color};">
             å¯¦éš›ï¼š<span style="font-weight: bold;">${actualDisplay}</span>
             <span style="font-size: 0.8em; font-weight: normal; color: #7f8c8d;">${logNote}</span>
          </p>
          <p class="plan-logic">ğŸ’¡ ${p.logic_note}</p>
        `;
        container.appendChild(card);
      });
    }

    /* =====================
       4. äº‹ä»¶ç›£è½ (ä¿®æ­£ç´€éŒ„å„²å­˜é‚è¼¯)
    ====================== */
    document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("log-date");
        if(dateInput) dateInput.valueAsDate = new Date();

        loadCurrentPlan();
        
        const generateBtn = document.getElementById("initial-generate-btn"); 
        const regenBtn = document.getElementById("regenerate-btn");

        // A. ç”¢ç”Ÿ/é‡æ–°ç”Ÿæˆè¨ˆç•«æŒ‰éˆ•é‚è¼¯ (ä¿æŒä¸è®Š)
        const handleGenerate = async (btn) => {
            const wfhCheckboxes = document.querySelectorAll(".wfh-day:checked");
            const wfhDays = Array.from(wfhCheckboxes).map(cb => Number(cb.value));
            const satActivity = document.getElementById("sat-activity").value;
            const sunActivity = document.getElementById("sun-activity").value;
            
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;

            try {
                const exerciseDB = await fetchExerciseList(); 
                const history = MOCK_HISTORY; 

                const plan = generateWeeklyPlan({ wfhDays, satActivity, sunActivity }, exerciseDB, history);
                
                renderWeeklyPlan(plan); 
                await saveWeeklyPlan(plan);
                
                loadCurrentPlan(); // åˆ·æ–° currentPlan
                document.getElementById("weekplan-section").scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error(e);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Console");
            } finally {
                btn.innerText = "ç”¢ç”Ÿæœ¬é€±å»ºè­°";
                btn.disabled = false;
            }
        };

        if(generateBtn) generateBtn.addEventListener("click", () => handleGenerate(generateBtn));
        if(regenBtn) regenBtn.addEventListener("click", () => handleGenerate(regenBtn));
        
        // B. è™•ç†é‹å‹•ç´€éŒ„å„²å­˜æŒ‰éˆ• (æ ¸å¿ƒä¿®æ­£)
        const logSaveBtn = document.getElementById("log-save-btn"); 
        if(logSaveBtn) {
            logSaveBtn.addEventListener("click", async () => {
                const logDate = document.getElementById("log-date").value;
                const actualActivity = document.getElementById("actual-activity").value;
                const duration = Number(document.getElementById("log-duration").value);
                const note = document.getElementById("log-note").value;
    
                if (!logDate || !actualActivity) {
                    alert("è«‹å¡«å¯«æ—¥æœŸèˆ‡å¯¦éš›é‹å‹•å…§å®¹ã€‚");
                    return;
                }
                
                // â˜… 1. æŸ¥æ‰¾å°æ‡‰è¨ˆç•« â˜…
                const planEntry = currentPlan.find(p => p.date === logDate);

                if (!planEntry) {
                    alert("éŒ¯èª¤ï¼šè«‹å…ˆç”Ÿæˆæœ¬é€±é‹å‹•è¨ˆç•«ï¼Œæˆ–æª¢æŸ¥è¼¸å…¥çš„æ—¥æœŸæ˜¯å¦åœ¨æœ¬é€±è¨ˆç•«ç¯„åœå…§ã€‚");
                    return;
                }
                
                // â˜… 2. æ§‹å»ºç¬¦åˆ Sheet æ¬„ä½é †åºçš„ logData â˜…
                const logData = {
                    date: logDate,                          // æ¬„ä½ 1: æ—¥æœŸ
                    weekday: planEntry.weekday,             // æ¬„ä½ 2: æ˜ŸæœŸ
                    suggestion: planEntry.suggestion,       // æ¬„ä½ 3: è¨ˆç•«é‹å‹•å…§å®¹
                    actual: actualActivity,                 // æ¬„ä½ 4: å¯¦éš›é‹å‹•å…§å®¹
                    duration: duration,                     // æ¬„ä½ 5: å¯¦éš›é‹å‹•æ™‚é–“
                    note: note                              // æ¬„ä½ 6: å‚™è¨»
                };
    
                logSaveBtn.innerText = "å„²å­˜ä¸­...";
                logSaveBtn.disabled = true;
    
                try {
                    const result = await saveExerciseLog(logData);
                    if (result && result.status === "ok") {
                        alert("é‹å‹•ç´€éŒ„å„²å­˜æˆåŠŸï¼");
                        loadCurrentPlan();
                        document.getElementById("actual-activity").value = "";
                        document.getElementById("log-duration").value = "";
                        document.getElementById("log-note").value = "";
                    } else {
                        throw new Error("API å„²å­˜å¤±æ•—ã€‚");
                    }
                } catch (e) {
                    console.error(e);
                    alert("å„²å­˜ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Consoleã€‚");
                } finally {
                    logSaveBtn.innerText = "å›å­˜ç´€éŒ„";
                    logSaveBtn.disabled = false;
                }
            });
        }
    });
</script>

</body>
</html>