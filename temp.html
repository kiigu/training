<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æ¯é€±é‹å‹•è¨ˆç•« Â· Personal Weekly Fitness</title>
  <link rel="icon" type="image/png" href="./icon.png">
  <link rel="apple-touch-icon" href="./icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./icon.png">
  <style>
    /* ===== CSS:BASE ====414= */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC";
      background: #ffffff;
      color: #101820;
      line-height: 1.5;
    }
    .page { min-height: 100vh; display: flex; flex-direction: column; }
    .container { width: 100%; max-width: 960px; margin: 0 auto; padding: 0 16px; }

    /* ===== Header ===== */
    header.site-header {
      background: #f8fafb;
      border-bottom: 1px solid #e6eef6;
      position: sticky;
      top: 0; z-index: 999;
    }
    .nav { display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .site-title { font-size: 1.1rem; font-weight: 700; color: #0b556a; text-decoration: none; }
    .nav-links { display: flex; gap: 12px; }
    .nav-link { color: #0b556a; text-decoration: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;}
    .nav-link:hover { background: rgba(11,85,106,0.08); }

    /* ===== Sections ===== */
    .section { padding: 30px 0; }
    .section-title { font-size: 1.2rem; color: #0b556a; margin: 0 0 12px 0; }

    /* ===== Cards / Inputs ===== */
    .card {
      background: #ffffff;
      border: 1px solid #eaeef2;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .input-pill {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #dbe4e8;
      font-size: 1rem;
    }
    .input-group { margin-bottom: 12px; }
    select.input-pill { background: white; }

    button.btn {
      background: #0b556a;
      color: white;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 6px;
      transition: background 0.2s;
    }
    button.btn:hover { background: #084152; }
    button.btn:active { transform: translateY(1px); }

    /* ===== Plan Cards ===== */
    .plan-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .plan-day {
      border-left: 5px solid #0b556a;
      padding-left: 16px;
    }
    .day-header { display: flex; justify-content: space-between; align-items: baseline; }
    .day-title { margin: 0; font-size: 1.1rem; }
    .day-date { font-size: 0.85rem; color: #889; }
    .plan-suggestion { font-weight: 600; color: #2c3e50; margin: 8px 0; font-size: 1.05rem; }
    .plan-logic { color: #889; font-size: 0.85rem; margin: 0; }

    /* ===== LOG SECTION ===== */
    .log-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .log-item { flex: 1; min-width: 180px; }

    @media (min-width: 768px) {
      .plan-grid { grid-template-columns: repeat(2,1fr); }
    }
    @media (min-width: 1200px) {
      .plan-grid { grid-template-columns: repeat(3,1fr); }
    }
  </style>
</head>

<body>
  <div class="page">

    <header class="site-header">
      <div class="container nav">
        <a class="site-title" href="#hero">MyWeekly Â· é‹å‹•è¨ˆç•«</a>
        <nav class="nav-links">
          <a href="#hero" class="nav-link">é¦–é </a>
          <a href="#weekplan-section" class="nav-link">æœ¬é€±è¨ˆç•«</a>
          <a href="#log-section" class="nav-link">ç´€éŒ„</a>
        </nav>
      </div>
    </header>

    <main>
      <div class="container">

        <section id="hero" class="section section-hero">
          <h1 class="section-title">è¼¸å…¥æœ¬é€±è¡Œç¨‹</h1>

          <div class="card">
            <p>è«‹é¸æ“‡æœ¬é€±åœ¨å®¶å·¥ä½œæ—¥ï¼ˆå¤šé¸ï¼‰ï¼š</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 16px;">
              <label><input type="checkbox" class="wfh-day" value="1"> ä¸€</label>
              <label><input type="checkbox" class="wfh-day" value="2"> äºŒ</label>
              <label><input type="checkbox" class="wfh-day" value="3"> ä¸‰</label>
              <label><input type="checkbox" class="wfh-day" value="4"> å››</label>
              <label><input type="checkbox" class="wfh-day" value="5"> äº”</label>
            </div>

            <p style="margin-top:16px; border-top: 1px solid #eee; padding-top:16px;"></p>
              <div class="input-group">
                <label for="sat-activity">é€±å…­æ´»å‹•</label>
                <select id="sat-activity" class="input-pill">
                  <option value="none">ç„¡æ´»å‹•ï¼ˆå¯é‹å‹•ï¼‰</option>
                  <option value="half">åŠå¤©æœ‰æ´»å‹•ï¼ˆè¼•åº¦é‹å‹•ï¼‰</option>
                  <option value="full">æ•´å¤©æœ‰æ´»å‹•ï¼ˆä»¥ä¼¸å±•ç‚ºä¸»ï¼‰</option>
                </select>
              </div>

              <div class="input-group">
                <label for="sun-activity">é€±æ—¥æ´»å‹•</label>
                <select id="sun-activity" class="input-pill">
                  <option value="none">ç„¡æ´»å‹•ï¼ˆå¯é‹å‹•ï¼‰</option>
                  <option value="half">åŠå¤©æœ‰æ´»å‹•ï¼ˆè¼•åº¦é‹å‹•ï¼‰</option>
                  <option value="full">æ•´å¤©æœ‰æ´»å‹•ï¼ˆä»¥ä¼¸å±•ç‚ºä¸»ï¼‰</option>
                </select>
              </div>

            <div style="margin-top:24px;">
              <button id="generate-btn" class="btn">ç”¢ç”Ÿæœ¬é€±å»ºè­°</button>
              <button id="regenerate-btn" class="btn" style="background:#6c757d;">é‡æ–°ç”Ÿæˆ</button>
            </div>
          </div>
        </section>

        <section id="weekplan-section" class="section section-week-plan">
          <h2 class="section-title">æœ¬é€±é‹å‹•è¨ˆç•«</h2>
          <div id="weekly-plan-container" class="plan-grid">
            <div style="color:#888; grid-column: 1/-1;">å°šæœªç”Ÿæˆè¨ˆç•«ï¼Œè«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•ã€‚</div>
          </div>
        </section>

        <section id="log-section" class="section section-log">
          <h2 class="section-title">[å»ºç½®ä¸­]æ¯æ—¥é‹å‹•ç´€éŒ„</h2>

          <div class="card">
            <div class="log-row">
              <div class="log-item">
                <label>æ—¥æœŸï¼š</label>
                <input id="log-date" class="input-pill" type="date" />
              </div>

              <div class="log-item">
                <label>å¯¦éš›é‹å‹•å…§å®¹ï¼š</label>
                <input id="log-actual" class="input-pill" type="text" placeholder="ä¾‹å¦‚ï¼šè·‘æ­¥ 20 åˆ†" />
              </div>

              <div class="log-item">
                <label>æ™‚é–“ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
                <input id="log-duration" class="input-pill" type="number" min="1" />
              </div>
            </div>

            <div style="margin-top:12px;">
              <label>å‚™è¨»ï¼š</label>
              <input id="log-note" class="input-pill" type="text" placeholder="å¯ç•™ç©º" />
            </div>

            <div style="margin-top:18px;">
              <button id="save-log-btn" class="btn">å›å­˜ç´€éŒ„</button>
            </div>

            <p id="log-message" style="color:#0b556a; margin-top:10px;"></p>
          </div>
        </section>

      </div>
    </main>

    <footer class="site-footer" style="padding:16px; text-align:center; background:#f5f8fa; color: #888;">
      MyWeekly Â· é‹å‹•è¨ˆç•«
    </footer>
  </div>

<script>
    /* =====================
       1. è³‡æ–™è¨­å®šèˆ‡ API
    ====================== */
    // â˜… è«‹å°‡ä¸‹æ–¹ç¶²å€æ›æˆä½ å‰›å‰›éƒ¨ç½²å¾Œå–å¾—çš„æ–°ç¶²å€ â˜…
    const API_BASE = "https://script.google.com/macros/s/AKfycbySvjyvZZsGZuhv0W-dnbuJH0mMg8CXK9MAToktPCY5oMRNooA-q0AZ_VoRcMJXhbmc/exec"; 
    
    // æ³¨æ„ï¼šåŸæœ¬å¯«æ­»çš„ EXERCISE_DB å·²ç¶“ç§»é™¤äº†ï¼Œç¾åœ¨æˆ‘å€‘é  API æŠ“å–
    
    // æ¨¡æ“¬æ­·å²ç´€éŒ„ (è¦å‰‡ 8)ï¼Œå¦‚æœä¹‹å¾Œä¹Ÿè¦è®€ Sheetï¼Œé‚è¼¯é¡ä¼¼ getExerciseList
    let MOCK_HISTORY = ["è·‘æ­¥ (30åˆ†)", "é‡é‡è¨“ç·´#1 (20åˆ†)"]; 

    async function callAPI(action, method="GET", body=null) {
      // â˜…é€™è£¡é–‹å•ŸçœŸå¯¦é€£ç·šâ˜…
      const options = { method };
      
      // Google Apps Script çš„ doPost éœ€è¦ç‰¹æ®Šè™•ç†ï¼Œé€šå¸¸ç”¨ text/plain æˆ–ä¸è¨­ content-type é¿å… CORS é—®é¢˜ï¼Œ
      // ä½†ç°¡å–®çš„ GET è«‹æ±‚å¦‚ä¸‹å³å¯ï¼š
      if (method === "POST" && body) {
         options.body = JSON.stringify(body);
         // ç‚ºäº†é…åˆ GAS ç°¡å–®å¯¦ä½œï¼Œé€™è£¡ç”¨ no-cors æˆ– text/plain æ¯”è¼ƒä¿éšªï¼Œ
         // ä½†ç‚ºäº†è®€å–è³‡æ–™ï¼Œæˆ‘å€‘å…ˆå°ˆæ³¨åœ¨ GET
      }
      
      try {
        const res = await fetch(`${API_BASE}?action=${action}`, options);
        return await res.json();
      } catch (e) {
        console.error("API Error:", e);
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç¶²å€");
        return null;
      }
    }

    async function fetchExerciseList(){ 
      const data = await callAPI("getExerciseList");
      // å¦‚æœ API å¤±æ•—ï¼Œå›å‚³ç©ºç‰©ä»¶é¿å…å ±éŒ¯
      return data || { "Yoga":[], "Cardio":[], "Weight":[], "Running":[], "Stretching":[] };
    }
    
    async function fetchHistory(){ return await callAPI("getHistory"); }
    async function saveWeeklyPlan(plan){ return callAPI("saveWeeklyPlan","POST",{plan}); }
    async function saveExerciseLog(log){ return callAPI("saveLog","POST",log); }

    /* =====================
       2. æ ¸å¿ƒé‚è¼¯ï¼šç”Ÿæˆé‹å‹•è¨ˆç•« (é‚è¼¯ç¶­æŒä¸è®Š)
    ====================== */
    function generateWeeklyPlan(user, db, history) {
      const { wfhDays, satActivity, sunActivity } = user;
      const plan = [];
      const weekdays = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"];
      let selectedThisWeek = new Set();

      for(let i=0; i<7; i++){
        const dayIdx = i + 1; 
        const isWeekend = (dayIdx >= 6);
        let isWFH = (dayIdx <= 5) && wfhDays.includes(dayIdx);
        
        let activityLevel = "none"; 
        if(dayIdx === 6) activityLevel = satActivity;
        if(dayIdx === 7) activityLevel = sunActivity;

        let dayContext = {
          isWFH: isWFH,
          isFreeWeekend: isWeekend && activityLevel === "none",
          isBusyWeekend: isWeekend && activityLevel === "full",
          isHalfWeekend: isWeekend && activityLevel === "half",
          isOffice: (dayIdx <= 5) && !isWFH
        };

        let slots = 1;
        if (dayContext.isWFH || dayContext.isFreeWeekend) slots = 2;
        if (dayContext.isBusyWeekend) slots = 0; 

        let logicNote = "";
        if (dayContext.isOffice && dayIdx === 3) {
            slots = 0; 
            logicNote = "é€±ä¸­æ¢å¾©æ—¥";
        }

        let suggestion = [];

        if (slots === 0) {
           let item = pickExercise(db["Stretching"], history, selectedThisWeek);
           suggestion.push(item);
           if(!logicNote) logicNote = dayContext.isBusyWeekend ? "é€±æœ«å¿™ç¢Œï¼Œåƒ…ä¼¸å±•" : "ä¼‘æ¯æ—¥";
        } else {
           let canRun = dayContext.isFreeWeekend; 
           let canYoga = dayContext.isWFH || dayContext.isFreeWeekend; 
           let canCardio = dayContext.isWFH || (isWeekend && !dayContext.isBusyWeekend); 
           let canWeight = !dayContext.isBusyWeekend; 

           if (slots === 2) {
             let poolA = []; 
             if(canRun && db["Running"]) poolA.push("Running");
             if(canCardio && db["Cardio"]) poolA.push("Cardio");
             
             let poolB = []; 
             if(canWeight && db["Weight"]) poolB.push("Weight");
             if(canYoga && db["Yoga"]) poolB.push("Yoga");

             let catA = getRandomItem(poolA);
             let catB = getRandomItem(poolB);

             if(catA) suggestion.push(pickExercise(db[catA], history, selectedThisWeek));
             if(catB) suggestion.push(pickExercise(db[catB], history, selectedThisWeek));
             logicNote = "é›™é …è¨“ç·´ (WFH/å‡æ—¥)";
           } else {
             let validTypes = [];
             if(canWeight && db["Weight"]) validTypes.push("Weight");
             if(canYoga && db["Yoga"]) validTypes.push("Yoga");
             if(validTypes.length === 0 && canCardio && db["Cardio"]) validTypes.push("Cardio"); 
             if(validTypes.length === 0) validTypes.push("Stretching");

             let cat = getRandomItem(validTypes);
             suggestion.push(pickExercise(db[cat], history, selectedThisWeek));
             logicNote = "å–®é …è¨“ç·´";
           }
        }

        plan.push({
          weekday: weekdays[i],
          suggestion: suggestion.join(" + "),
          logic_note: logicNote,
          date: getDateOfWeek(i)
        });
      }
      return plan;
    }

    function pickExercise(list, history, currentWeekSet) {
      if(!list || list.length === 0) return "è‡ªç”±ä¼¸å±•";
      // ç°¡å–®éæ¿¾ï¼šåªè¦åç¨±åŒ…å«æ­·å²ç´€éŒ„çš„é—œéµå­—å°±æ’é™¤ (æ¯”è¼ƒå¯¬é¬†)
      let candidates = list.filter(ex => {
         // æª¢æŸ¥æ˜¯å¦åœ¨æ­·å²ç´€éŒ„æˆ–æœ¬é€±å·²é¸ä¸­
         const isPlayed = history.some(h => ex.includes(h)) || currentWeekSet.has(ex);
         return !isPlayed;
      });

      if(candidates.length === 0) candidates = list;
      const picked = getRandomItem(candidates);
      currentWeekSet.add(picked);
      return picked;
    }

    function getRandomItem(arr) {
      if(!arr || arr.length === 0) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getDateOfWeek(index) {
      const today = new Date();
      const day = today.getDay(); // 0(æ—¥)~6(å…­)

      // å°‡æ˜ŸæœŸæ—¥è¦–ç‚ºä¸€é€±æœ€å¾Œä¸€å¤© â†’ æŠŠå®ƒèª¿æ•´ç‚º 7
      const normalizedDay = (day === 0 ? 7 : day);

      // æ‰¾åˆ°æœ¬é€±çš„æ˜ŸæœŸä¸€
      const monday = new Date(today);
      monday.setDate(today.getDate() - (normalizedDay - 1));

      // å–å¾—æ˜ŸæœŸ indexï¼ˆ0=é€±ä¸€, 6=é€±æ—¥ï¼‰
      const target = new Date(monday);
      target.setDate(monday.getDate() + index);

      return target.toISOString().split("T")[0];
    }


    /* =====================
       3. ç•«é¢æ¸²æŸ“èˆ‡äº‹ä»¶ (ç¶­æŒä¸è®Š)
    ====================== */
    function renderWeeklyPlan(plan){
      const container = document.getElementById("weekly-plan-container");
      container.innerHTML = "";
      plan.forEach(p => {
        const card = document.createElement("div");
        card.className = "card plan-day";
        let color = "#0b556a";
        if(p.suggestion.includes("ä¼¸å±•") || p.suggestion.includes("ä¼‘æ¯")) color = "#2ecc71";
        if(p.suggestion.includes("+")) color = "#e74c3c";
        card.style.borderLeftColor = color;
        card.innerHTML = `
          <div class="day-header">
            <h3 class="day-title">é€±${p.weekday}</h3>
            <span class="day-date">${p.date}</span>
          </div>
          <p class="plan-suggestion" style="color:${color}">${p.suggestion}</p>
          <p class="plan-logic">ğŸ’¡ ${p.logic_note}</p>
        `;
        container.appendChild(card);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const generateBtn = document.getElementById("generate-btn");
      if(generateBtn) {
        generateBtn.addEventListener("click", async () => {
          const wfhCheckboxes = document.querySelectorAll(".wfh-day:checked");
          const wfhDays = Array.from(wfhCheckboxes).map(cb => Number(cb.value));
          const satActivity = document.getElementById("sat-activity").value;
          const sunActivity = document.getElementById("sun-activity").value;
          
          generateBtn.innerText = "è®€å–è³‡æ–™ä¸­...";
          generateBtn.disabled = true;

          try {
            // â˜… ä¿®æ”¹é»ï¼šç­‰å¾… API å›å‚³çœŸå¯¦è³‡æ–™ â˜…
            const exerciseDB = await fetchExerciseList(); 
            // é€™è£¡é‚„æ˜¯ç”¨æ¨¡æ“¬æ­·å²ï¼Œå¦‚æœä½ å¾Œç«¯ getHistory å¯«å¥½äº†å¯ä»¥æ›æˆ await fetchHistory()
            const history = MOCK_HISTORY; 

            const plan = generateWeeklyPlan({ wfhDays, satActivity, sunActivity }, exerciseDB, history);
            renderWeeklyPlan(plan);
            await saveWeeklyPlan(plan);
            
            document.getElementById("weekplan-section").scrollIntoView({ behavior: 'smooth' });
          } catch (e) {
            console.error(e);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Console");
          } finally {
            generateBtn.innerText = "ç”¢ç”Ÿæœ¬é€±å»ºè­°";
            generateBtn.disabled = false;
          }
        });
      }

      // å…¶ä»–æŒ‰éˆ•é‚è¼¯ä¿æŒåŸæœ¬æ¨£å¼...
      const regenBtn = document.getElementById("regenerate-btn");
      if(regenBtn) regenBtn.addEventListener("click", () => document.getElementById("generate-btn").click());
      const dateInput = document.getElementById("log-date");
      if(dateInput) dateInput.valueAsDate = new Date();
    });
  </script>
</body>
</html>